<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Abrox ‚Äì Profit Hunters Chat</title>

  <!-- widget CSS -->
  <link rel="stylesheet" href="widget.css" />

  <script>
    // Site configuration
    window.CONTACT_ADMIN_LINK = "https://t.me/ph_suppp";
    window.MEMBER_COUNT = 1284;
    window.ONLINE_COUNT = 128;

    window.REALISM_CONFIG = {
      TOTAL_PERSONAS: 1200,
      INITIAL_POOL: 400,
      POOL_MIN: 300,
      POOL_MAX: 3000,
      DEDUP_LIMIT: 200000,
      MIN_INTERVAL_MS: 20000,
      MAX_INTERVAL_MS: 60000,
      REACTION_TICK_MS: 30000,
      TREND_SPIKE_PROB: 0.02
    };

    window.JOINER_CONFIG = {
      minIntervalMs: 1000 * 60 * 60 * 6,
      maxIntervalMs: 1000 * 60 * 60 * 24,
      initialJoins: 3,
      welcomeMessage: "Welcome! Please use Contact Admin to verify."
    };
  </script>
</head>
<body>
  <div id="tg-comments-app">
    <!-- HEADER -->
    <header class="tg-header" role="banner">
      <button id="tg-back" class="tg-back-btn" aria-label="Back">
        <i data-lucide="arrow-left"></i>
      </button>

      <div class="tg-header-center">
        <img src="assets/logo.jpg" alt="Logo" class="tg-header-avatar" />
        <div class="tg-header-info">
          <div class="tg-title">üåê Profit Hunters Chat</div>
          <div class="tg-meta" id="tg-meta-line">1,284 members, 128 online</div>
        </div>
      </div>

      <button id="tg-options" class="tg-options-btn" aria-label="Options">
        <i data-lucide="more-vertical"></i>
      </button>
    </header>

    <!-- PIN BANNER -->
    <div id="tg-pin-banner" class="tg-pin-banner hidden" role="region" aria-live="polite"></div>

    <!-- CHAT CONTAINER -->
    <main id="tg-comments-container" class="tg-comments-container" role="feed" aria-live="off"></main>

    <!-- NEW MESSAGE JUMP INDICATOR -->
    <div id="tg-jump-indicator" class="hidden" aria-hidden="true">
      <i data-lucide="chevron-down"></i>
      <span id="tg-jump-text">New messages</span>
    </div>

    <!-- INPUT BAR -->
    <div class="tg-input-wrapper" role="form" aria-label="Send a message">
      <div class="tg-input-bar glass">
        <button id="tg-emoji-btn" class="tg-icon-btn" aria-label="Emoji">
          <i data-lucide="smile"></i>
        </button>

        <input
          type="text"
          id="tg-comment-input"
          class="tg-comment-input"
          placeholder="Message‚Ä¶"
          autocomplete="off"
        />

        <button id="tg-camera-btn" class="tg-icon-btn" aria-label="Camera">
          <i data-lucide="camera"></i>
        </button>

        <button id="tg-send-btn" class="tg-send-btn hidden" aria-label="Send message">
          <i data-lucide="send"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Scripts (load in order) -->
  <script src="identity-personas.js"></script>
  <script src="bubble-renderer.js"></script>
  <script src="joiner-simulator.js"></script>
  <script src="realism-engine-v11.js"></script>
  <script src="interactions.js"></script>
  <script src="app.js"></script>

  <script>
    // LocalStorage-based chat history
    const HISTORY_KEY = "abrox_chat_history";
    const container = document.getElementById("tg-comments-container");

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return;

        arr.forEach(item => {
          if (window.TGRenderer?.appendMessage) {
            window.TGRenderer.appendMessage(item.persona, item.text, {
              type: item.type || "incoming",
              timestamp: new Date(item.timestamp),
              replyToText: item.replyToText || null
            });
          }
        });
      } catch (e) {
        console.warn("Failed to load history", e);
      }
    }

    function saveHistory(persona, text, opts = {}) {
      try {
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        history.push({
          persona,
          text,
          type: opts.type || "incoming",
          timestamp: opts.timestamp || new Date(),
          replyToText: opts.replyToText || null
        });
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(-500))); // keep last 500
      } catch (e) {
        console.warn("Failed to save history", e);
      }
    }

    // Hook TGRenderer append to save automatically
    if (window.TGRenderer) {
      const origAppend = window.TGRenderer.appendMessage;
      window.TGRenderer.appendMessage = function(persona, text, opts = {}) {
        const id = origAppend(persona, text, opts);
        saveHistory(persona, text, opts);
        return id;
      };
    }

    // Load previous messages on page load
    loadHistory();

    if(window.lucide?.createIcons){ window.lucide.createIcons(); }
  </script>
</body>
</html>
